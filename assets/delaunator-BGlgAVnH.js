const O=Math.pow(2,-52),G=new Uint32Array(512);class R{static from(t,n=Z,e=$){const o=t.length,l=new Float64Array(o*2);for(let s=0;s<o;s++){const h=t[s];l[2*s]=n(h),l[2*s+1]=e(h)}return new R(l)}constructor(t){const n=t.length>>1;if(n>0&&typeof t[0]!="number")throw new Error("Expected coords to contain numbers.");this.coords=t;const e=Math.max(2*n-5,0);this._triangles=new Uint32Array(e*3),this._halfedges=new Int32Array(e*3),this._hashSize=Math.ceil(Math.sqrt(n)),this._hullPrev=new Uint32Array(n),this._hullNext=new Uint32Array(n),this._hullTri=new Uint32Array(n),this._hullHash=new Int32Array(this._hashSize).fill(-1),this._ids=new Uint32Array(n),this._dists=new Float64Array(n),this.update()}update(){const{coords:t,_hullPrev:n,_hullNext:e,_hullTri:o,_hullHash:l}=this,s=t.length>>1;let h=1/0,u=1/0,f=-1/0,m=-1/0;for(let r=0;r<s;r++){const c=t[2*r],g=t[2*r+1];c<h&&(h=c),g<u&&(u=g),c>f&&(f=c),g>m&&(m=g),this._ids[r]=r}const d=(h+f)/2,x=(u+m)/2;let w=1/0,_,y,k;for(let r=0;r<s;r++){const c=C(d,x,t[2*r],t[2*r+1]);c<w&&(_=r,w=c)}const z=t[2*_],M=t[2*_+1];w=1/0;for(let r=0;r<s;r++){if(r===_)continue;const c=C(z,M,t[2*r],t[2*r+1]);c<w&&c>0&&(y=r,w=c)}let S=t[2*y],L=t[2*y+1],X=1/0;for(let r=0;r<s;r++){if(r===_||r===y)continue;const c=V(z,M,S,L,t[2*r],t[2*r+1]);c<X&&(k=r,X=c)}let E=t[2*k],P=t[2*k+1];if(X===1/0){for(let g=0;g<s;g++)this._dists[g]=t[2*g]-t[0]||t[2*g+1]-t[1];D(this._ids,this._dists,0,s-1);const r=new Uint32Array(s);let c=0;for(let g=0,b=-1/0;g<s;g++){const p=this._ids[g];this._dists[p]>b&&(r[c++]=p,b=this._dists[p])}this.hull=r.subarray(0,c),this.triangles=new Uint32Array(0),this.halfedges=new Uint32Array(0);return}if(H(z,M,S,L,E,P)){const r=y,c=S,g=L;y=k,S=E,L=P,k=r,E=c,P=g}const j=W(z,M,S,L,E,P);this._cx=j.x,this._cy=j.y;for(let r=0;r<s;r++)this._dists[r]=C(t[2*r],t[2*r+1],j.x,j.y);D(this._ids,this._dists,0,s-1),this._hullStart=_;let v=3;e[_]=n[k]=y,e[y]=n[_]=k,e[k]=n[y]=_,o[_]=0,o[y]=1,o[k]=2,l.fill(-1),l[this._hashKey(z,M)]=_,l[this._hashKey(S,L)]=y,l[this._hashKey(E,P)]=k,this.trianglesLen=0,this._addTriangle(_,y,k,-1,-1,-1);for(let r=0,c,g;r<this._ids.length;r++){const b=this._ids[r],p=t[2*b],U=t[2*b+1];if(r>0&&Math.abs(p-c)<=O&&Math.abs(U-g)<=O||(c=p,g=U,b===_||b===y||b===k))continue;let T=0;for(let Y=0,B=this._hashKey(p,U);Y<this._hashSize&&(T=l[(B+Y)%this._hashSize],!(T!==-1&&T!==e[T]));Y++);T=n[T];let a=T,A;for(;A=e[a],!H(p,U,t[2*a],t[2*a+1],t[2*A],t[2*A+1]);)if(a=A,a===T){a=-1;break}if(a===-1)continue;let K=this._addTriangle(a,b,e[a],-1,-1,o[a]);o[b]=this._legalize(K+2),o[a]=K,v++;let I=e[a];for(;A=e[I],H(p,U,t[2*I],t[2*I+1],t[2*A],t[2*A+1]);)K=this._addTriangle(I,b,A,o[b],-1,o[I]),o[b]=this._legalize(K+2),e[I]=I,v--,I=A;if(a===T)for(;A=n[a],H(p,U,t[2*A],t[2*A+1],t[2*a],t[2*a+1]);)K=this._addTriangle(A,b,a,-1,o[a],o[A]),this._legalize(K+2),o[A]=K,e[a]=a,v--,a=A;this._hullStart=n[b]=a,e[a]=n[I]=b,e[b]=I,l[this._hashKey(p,U)]=b,l[this._hashKey(t[2*a],t[2*a+1])]=a}this.hull=new Uint32Array(v);for(let r=0,c=this._hullStart;r<v;r++)this.hull[r]=c,c=e[c];this.triangles=this._triangles.subarray(0,this.trianglesLen),this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}_hashKey(t,n){return Math.floor(J(t-this._cx,n-this._cy)*this._hashSize)%this._hashSize}_legalize(t){const{_triangles:n,_halfedges:e,coords:o}=this;let l=0,s=0;for(;;){const h=e[t],u=t-t%3;if(s=u+(t+2)%3,h===-1){if(l===0)break;t=G[--l];continue}const f=h-h%3,m=u+(t+1)%3,d=f+(h+2)%3,x=n[s],w=n[t],_=n[m],y=n[d];if(Q(o[2*x],o[2*x+1],o[2*w],o[2*w+1],o[2*_],o[2*_+1],o[2*y],o[2*y+1])){n[t]=y,n[h]=x;const z=e[d];if(z===-1){let S=this._hullStart;do{if(this._hullTri[S]===d){this._hullTri[S]=t;break}S=this._hullPrev[S]}while(S!==this._hullStart)}this._link(t,z),this._link(h,e[s]),this._link(s,d);const M=f+(h+1)%3;l<G.length&&(G[l++]=M)}else{if(l===0)break;t=G[--l]}}return s}_link(t,n){this._halfedges[t]=n,n!==-1&&(this._halfedges[n]=t)}_addTriangle(t,n,e,o,l,s){const h=this.trianglesLen;return this._triangles[h]=t,this._triangles[h+1]=n,this._triangles[h+2]=e,this._link(h,o),this._link(h+1,l),this._link(h+2,s),this.trianglesLen+=3,h}}function J(i,t){const n=i/(Math.abs(i)+Math.abs(t));return(t>0?3-n:1+n)/4}function C(i,t,n,e){const o=i-n,l=t-e;return o*o+l*l}function F(i,t,n,e,o,l){const s=(e-t)*(o-i),h=(n-i)*(l-t);return Math.abs(s-h)>=33306690738754716e-32*Math.abs(s+h)?s-h:0}function H(i,t,n,e,o,l){return(F(o,l,i,t,n,e)||F(i,t,n,e,o,l)||F(n,e,o,l,i,t))<0}function Q(i,t,n,e,o,l,s,h){const u=i-s,f=t-h,m=n-s,d=e-h,x=o-s,w=l-h,_=u*u+f*f,y=m*m+d*d,k=x*x+w*w;return u*(d*k-y*w)-f*(m*k-y*x)+_*(m*w-d*x)<0}function V(i,t,n,e,o,l){const s=n-i,h=e-t,u=o-i,f=l-t,m=s*s+h*h,d=u*u+f*f,x=.5/(s*f-h*u),w=(f*m-h*d)*x,_=(s*d-u*m)*x;return w*w+_*_}function W(i,t,n,e,o,l){const s=n-i,h=e-t,u=o-i,f=l-t,m=s*s+h*h,d=u*u+f*f,x=.5/(s*f-h*u),w=i+(f*m-h*d)*x,_=t+(s*d-u*m)*x;return{x:w,y:_}}function D(i,t,n,e){if(e-n<=20)for(let o=n+1;o<=e;o++){const l=i[o],s=t[l];let h=o-1;for(;h>=n&&t[i[h]]>s;)i[h+1]=i[h--];i[h+1]=l}else{const o=n+e>>1;let l=n+1,s=e;N(i,o,l),t[i[n]]>t[i[e]]&&N(i,n,e),t[i[l]]>t[i[e]]&&N(i,l,e),t[i[n]]>t[i[l]]&&N(i,n,l);const h=i[l],u=t[h];for(;;){do l++;while(t[i[l]]<u);do s--;while(t[i[s]]>u);if(s<l)break;N(i,l,s)}i[n+1]=i[s],i[s]=h,e-l+1>=s-n?(D(i,t,l,e),D(i,t,n,s-1)):(D(i,t,n,s-1),D(i,t,l,e))}}function N(i,t,n){const e=i[t];i[t]=i[n],i[n]=e}function Z(i){return i[0]}function $(i){return i[1]}export{R as D};
